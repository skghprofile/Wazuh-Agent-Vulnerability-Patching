# Kali Linux VM Security Audit Patching

- In this section of the project, I will cover the process of hardening my Kali Linux virtual machine through Wazuh's system security audit since Wazuh didn't find any vulnerabilities in this machine.
- Below is a screenshot image of the initial scan of the Unix system. It contains the following:
  - 3 passed checks.
  - 13 failed checks.
  - 7 not applicable checks.
    ![Initial Security Audit](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img01.PNG)

Going into more detail, I can see what tasks must be performed to harden the system.
![Security System Audit Overview](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img02.PNG)

Going down the list, the first task I need to do is to change the default SSH port number to something else.
![SSH port should not be 22](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img03.PNG)
In the sshd_config file, I located line 14.
I then uncommented the line and switched it to port 2223.
![Locating SSH port line](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img04.PNG)
![Changing SSH port line](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img05.PNG)

The next item is to change the SSH protocol to 2.
Below the port line in the sshd_config file, I added an extra line to add the text "Protocol 2" since this was nowhere to be located in the file before I added it manually.
![SSH Protocol should be set to 2](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img06.PNG)
![Changing SSH protocol to 2](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img07.PNG)

The next item is to change the settings so the Root account cannot log in using SSH.
On line 34 of the sshd_config file, I uncommented "PermitRootLogin" and set it to "no".
![Disable Root account SSH login](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img08.PNG)
![Disabling Root account SSH login](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img09.PNG)

Next, SSH logins should only be allowed using public key authentication, not passwords.
On line 39 of the sshd_config file, I uncommented "PubKeyAuthentication" and set it to "yes".
![Public key authentication](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img10.PNG)
![Allowing public key authentication in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img11.PNG)

Next, to ensure SSH is only acced with public key authentication, I need to disable the "PasswordAuthentication" option.
On line 58 of the sshd_config file, I uncommented "PasswordAuthentication" and set it to "no".
![Password Authentication should be disabled](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img12.PNG)
![Disabling Password Authentication in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img13.PNG)

It is always good practice to not allow any accounts to have null passwords, but just in case there is one on the server, make the user unable to log in through SSH.
On line 59 of the sshd_config file, I uncommented "PermitEmptyPasswords" and set it to "no".
![Disable Empty Passwords](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img14.PNG)
![Disabling Empty Passwords in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img15.PNG)

Next is to turn off the use of the rhosts or shosts files used for authentication.
On line 55 of the sshd_config file, I uncommented "IgnoreRhosts" and set it to "yes".
![Disable rhost and shost files for authentication](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img16.PNG)
![Disabling rhost and shost files for authentication in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img17.PNG)

To shorten the amount of open connections to the SSH server, I can change the "LoginGraceTime" value.
On line 33 of the sshd_config file, I uncommented "LoginGraceTime" and set it to "60" for 60 seconds. By default, it was 2 minutes.
![Login Grace Time](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img18.PNG)
![Setting Login Grace Time to 60 seconds in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img19.PNG)

To detect a possible security threat through failed authentication attempts, I can change the "MaxAuthTries" value.
On line 36 of the sshd_config file, I uncommented "MaxAuthTries" and set it to "4". This will start to log additional failures at 2 failed authentication attempts, and not allow any additional authentication attempts after 4 failed tries.
![Maximum number of authentication attempts](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img20.PNG)
![Changing maximum number of authentication attempts in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img21.PNG)

To add another layer of protection to turn off authentication with rhosts files, I can change the "HostbasedAuthentication" setting to "no".
On line 50 of the sshd_config file, I uncommented "HostbasedAuthentication" and set it to "no".
![Disable SSH HostbasedAuthentication](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img22.PNG)
![Disabling SSH HostbasedAuthentication in config file](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img23.PNG)

To ensure account lockout after a specified number of failed login attempts, I can add a line to the "common-auth" file.
At the end of the common-auth file, I added the new auth line as stated in Wazuh's Remediation section of the audited event.
![Ensure account lockout](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img24.PNG)
![Adding line to ensure account lockout](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img25.PNG)

It's also good practice to have users change their password after some time in case their password is compromised and to reduce the likelihood of a successful brute force attack.
On line 165 of the login.defs file, I changed the "PASS_MAX_DAYS" to "364" since it was set to "99999" before.
![Ensure Password Expiration](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img26.PNG)
![Changing Password Expiration](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img27.PNG)

Since the auditid service was disabled and couldn't capture system events that could be malicious, I needed to enable the service.
I entered the command "sudo systemctl enable auditid" in a new terminal window to start the service.
![Enable Auditid Service](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img28.PNG)
![Terminal Command to enable AuditID](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img29.PNG)

After a few days of saving and applying the changes, I only had 2 failed checks left over.
![New Scan](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img30.PNG)

Looking at the more detailed view of the audit I can see the 2 failed checks. - The first failed check, being the "LoginGraceTime" value, I was unable to fix. I tried changing the value from "60" to "59" and even "29" but the audit was unable to see that the value was set to "60" or less. - The second failed check, ensuring lockout for failed password attempts, was a little more interesting. I could save and apply the new line that Wazuh provided, but after restarting the machine, I could not log in locally. I had to remove the line using a Bash shell in the GRUB loader to log in normally again. - I think the main problem I was facing with that new line was associated with the pam_tally2.so authentication.

![Detailed View Of New Scan](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img31.PNG)
![Passed Checks in New Scan](../../../Images/VulnerabilityPatchingImages/KaliMarch2024/kl-img32.PNG)

Overall, I am satisfied with the changes I made to harden my Kali Linux virtual machine, and almost pass all of the audit checks.
I learned more about the Linux filesystem and how files are organized.
I was also surprised to see other options for logging into SSH, such as Public Key Authentication, since passwords can be weak and easily brute-forced if not configured correctly.
